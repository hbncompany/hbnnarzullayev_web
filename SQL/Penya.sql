delete from nla where tin=(select tin from nl limit 1);
INSERT INTO nla (YNL,	NS10_CODE,	NS11_CODE,	tin, NA2_CODE,	DATE_SROK,	NACHISLEN_N,	UMENSHEN_N, UPLOCH_N, VOZVRAT, SPISANO_P, other_penya, shtraf, OWN_NS10_CODE,	OWN_NS11_CODE) select YNL,	NS10_CODE,	NS11_CODE,	tin, NA2_CODE,	DATE_SROK,	sum(NACHISLEN_N),	sum(UMENSHEN_N),	sum(ULPOCH_N), sum(VOZVRAT), sum(SPISANO_P), sum(ifnull(nachislen_p-umenshen_p,0)), sum(ifnull(shtraf,0)),	OWN_NS10_CODE,	OWN_NS11_CODE from nl where xar not in ('19','20') and na2_code not in ('46','101','199','191') group by YNL, NS10_CODE,	NS11_CODE,	tin, NA2_CODE,	DATE_SROK,	OWN_NS10_CODE,	OWN_NS11_CODE order by date_srok desc, na2_code asc;
insert into nla (ynl,ns10_code, ns11_code, tin, date_srok, na2_code) select YEAR(all_combinations.date_srok), (select ns10_code from nla where tin=(select tin from nl limit 1) group by ns10_code), (select ns11_code from nla where tin=(select tin from nl limit 1) group by ns11_code), (select tin from nl limit 1), all_combinations.date_srok, all_combinations.na2_code from (select dates.date_srok, numbers.na2_code from (select distinct date_srok from nla where ynl<'2020' and tin=(select tin from nl limit 1) group by date_srok) as dates cross join (select na2_code from nla where ynl<'2020' and tin=(select tin from nl limit 1) group by na2_code) as numbers) as all_combinations left join nla on all_combinations.date_srok=nla.date_srok and all_combinations.na2_code=nla.na2_code where nla.date_srok is null;
UPDATE nla SET last_date_srok = if(ynl>'2019',(SELECT t1.date_srok  FROM (SELECT * FROM nla) AS t1  WHERE t1.na2_code = nla.na2_code and t1.date_srok<nla.date_srok order by t1.date_srok desc limit 1),(SELECT t1.date_srok  FROM (SELECT * FROM nla) AS t1 where t1.date_srok<nla.date_srok order by t1.date_srok desc limit 1));
-- UPDATE nla SET last_date_srok = if(ynl>'2019',(SELECT t1.date_srok  FROM (SELECT * FROM nla) AS t1  WHERE t1.na2_code = nla.na2_code and t1.date_srok<nla.date_srok and t1.tin=(select tin from nl limit 1) order by t1.date_srok desc limit 1),(SELECT t1.date_srok  FROM (SELECT * FROM nla) AS t1 where t1.date_srok<nla.date_srok and t1.tin=(select tin from nl limit 1) order by t1.date_srok desc limit 1));
-- UPDATE nla AS target JOIN (SELECT nla.na2_code, MAX(IF(t1.date_srok < nla.date_srok, t1.date_srok, NULL)) AS new_last_date_srok  FROM nla JOIN (SELECT * FROM nla) AS t1 ON t1.na2_code = nla.na2_code JOIN nl ON t1.tin = (SELECT tin FROM nl LIMIT 1)  WHERE (nla.ynl > '2019' OR t1.date_srok < nla.date_srok)  GROUP BY nla.na2_code) AS subquery ON target.na2_code = subquery.na2_code SET target.last_date_srok = IFNULL(subquery.new_last_date_srok, target.last_date_srok);
update nla set nachislen_n=if(nachislen_n is null, 0, nachislen_n), umenshen_n=if(umenshen_n is null, 0, umenshen_n), uploch_n=if(uploch_n is null, 0, uploch_n), vozvrat=if(vozvrat is null, 0, vozvrat), saldo_all=if(saldo_all is null,0, saldo_all), saldo_sum_p=if(saldo_sum_p is null, 0, saldo_sum_p) where tin=(select tin from nl limit 1);
update nla set saldo_all=(0-nachislen_n+umenshen_n+uploch_n-vozvrat) where tin=(select tin from nl limit 1);
-- update nla set saldo_all=((select t1.saldo_all from (SELECT * FROM nla) as t1 where t1.date_srok=nla.last_date_srok and t1.na2_code=nla.na2_code and t1.tin=(select tin from nl limit 1) order by nla.date_srok, nla.na2_code)-nla.nachislen_n+nla.umenshen_n-nla.vozvrat+nla.uploch_n), saldo_sum_p=if(((select Foiz from (select * from penya) as t2 where t2.boshlanish_vaqti<=(select t1.date_srok from (SELECT * FROM nla) as t1 where t1.date_srok=nla.last_date_srok and t1.na2_code=nla.na2_code) order by boshlanish_vaqti desc limit 1)*(nla.date_srok-(select t1.date_srok from (SELECT * FROM nla) as t1 where t1.date_srok=nla.last_date_srok and t1.na2_code=nla.na2_code and t1.tin=(select tin from nl limit 1)))*((select t1.saldo_all from (SELECT * FROM nla) as t1 where t1.date_srok=nla.last_date_srok and t1.na2_code=nla.na2_code and t1.tin=(select tin from nl limit 1))-nla.nachislen_n+nla.umenshen_n-nla.vozvrat+nla.uploch_n)/30000)*0.6<0,(-1*(((select Foiz from (select * from penya) as t2 where t2.boshlanish_vaqti<=(select t1.date_srok from (SELECT * FROM nla) as t1 where t1.date_srok=nla.last_date_srok and t1.na2_code=nla.na2_code and t1.tin=(select tin from nl limit 1)) order by boshlanish_vaqti desc limit 1)*(nla.date_srok-(select t1.date_srok from (SELECT * FROM nla) as t1 where t1.date_srok=nla.last_date_srok and t1.na2_code=nla.na2_code and t1.tin=(select tin from nl limit 1)))*((select t1.saldo_all from (SELECT * FROM nla) as t1 where t1.date_srok=nla.last_date_srok and t1.na2_code=nla.na2_code and t1.tin=(select tin from nl limit 1))-nla.nachislen_n+nla.umenshen_n-nla.vozvrat+nla.uploch_n)/30000)*0.6)),0);
update nla set last_date_srok = date_srok where last_date_srok is null and tin=(select tin from nl limit 1);
update nla set saldo_all=(0-nachislen_n+umenshen_n+uploch_n-vozvrat), uploch_p = 0,  pr_sum =0, pr_saldo_all=0,pr_saldo=0, pr_penya_all=0, pr_penya=0 where tin=(select tin from nl limit 1);
-- UPDATE nla SET uploch_p = 0,  pr_sum =0, pr_saldo_all=0,pr_saldo=0, pr_penya_all=0, pr_penya=0;